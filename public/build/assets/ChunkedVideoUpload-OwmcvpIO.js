import{r as l,E as Q,c as x,o as k,j as _,b as t,G as A,q as N,t as u,S as Y}from"./app-BLMHNAP5.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ee={class:"chunked-upload-container"},te={key:0,class:"upload-area"},se={key:1,class:"mt-4 p-4 bg-slate-50 rounded-xl"},ae={class:"flex items-center justify-between"},oe={class:"flex items-center space-x-3"},le={class:"font-medium text-slate-700"},ne={class:"text-sm text-slate-500"},re={key:2,class:"mt-4"},ie={class:"bg-white rounded-xl p-6 shadow-sm border"},de={class:"flex items-center justify-between mb-4"},ce={class:"flex items-center space-x-3"},ue={class:"text-sm text-slate-600"},pe={class:"space-y-2"},ve={class:"flex justify-between text-sm"},fe={class:"font-medium"},he={class:"w-full bg-slate-200 rounded-full h-3"},me={class:"flex justify-between text-xs text-slate-500"},ge={key:3,class:"mt-4"},xe={key:4,class:"mt-4"},ke={class:"bg-red-50 border border-red-200 rounded-xl p-4"},we={class:"flex items-center space-x-3"},ye={class:"text-sm text-red-600"},be={__name:"ChunkedVideoUpload",props:{maxFileSize:{type:Number,default:1024*1024*1024},chunkSize:{type:Number,default:1024*1024*2}},emits:["upload-success","upload-error","cancel"],setup(V,{emit:D}){const m=V,M=D,d=l(null),j=l(null),O=l(!1),R=l(0),p=l(!1),w=l(0),y=l(0),b=l(0),v=l(!1),c=l(""),f=l("");l(!1);const E=l(null),g=l(0),S=l(0),U=l("Calculating..."),z=l("Calculating..."),L=s=>{const e=s.target.files[0];e&&B(e)},K=s=>{const e=s.dataTransfer.files[0];e&&B(e)},B=s=>{if(!s.type.startsWith("video/")){c.value="Please select a valid video file";return}if(s.size>m.maxFileSize){c.value=`File size exceeds ${C(m.maxFileSize)} limit`;return}d.value=s,c.value="",v.value=!1},q=()=>{d.value=null,j.value=null,c.value="",v.value=!1},T=async()=>{if(d.value)try{c.value="",p.value=!0,E.value=Date.now(),S.value=d.value.size,g.value=0,await I(d.value)}catch(s){console.error("Upload error:",s),c.value=s.message||"Upload failed. Please try again.",p.value=!1,M("upload-error",s.message)}},I=async s=>{const e=Math.ceil(s.size/m.chunkSize);b.value=e;const o=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");if(!o)throw new Error("CSRF token not found. Please refresh the page.");const a=await fetch("/api/upload/initiate",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":o,Accept:"application/json"},credentials:"same-origin",body:JSON.stringify({fileName:s.name,fileSize:s.size,chunkSize:m.chunkSize,totalChunks:e})});if(!a.ok)throw a.status===401?new Error("Session expired. Please refresh the page and try again."):a.status===419?new Error("CSRF token mismatch. Please refresh the page."):new Error(`Server error: ${a.status}`);const r=await a.json();if(!r.success)throw new Error(r.error||"Failed to initialize upload");f.value=r.uploadId,await X(s,e)},X=async(s,e)=>{const a=[];for(let n=0;n<e;n++)a.push(()=>G(s,n));let r=0;const i=new Set;for(;r<a.length||i.size>0;){for(;i.size<3&&r<a.length;){const n=a[r++]().then(()=>{i.delete(n)}).catch(h=>{throw i.delete(n),h});i.add(n)}i.size>0&&await Promise.race(i)}await W()},G=async(s,e)=>{const o=e*m.chunkSize,a=Math.min(o+m.chunkSize,s.size),r=s.slice(o,a),i=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),n=new FormData;n.append("chunk",r),n.append("chunkNumber",e),n.append("totalChunks",b.value);const h=await fetch(`/api/upload/${f.value}/chunk`,{method:"POST",headers:{"X-CSRF-TOKEN":i,Accept:"application/json"},credentials:"same-origin",body:n});if(!h.ok)throw h.status===401||h.status===419?new Error("Session expired. Please refresh the page."):new Error(`Chunk ${e} upload failed: ${h.status}`);const F=await h.json();if(!F.success)throw new Error(F.error||"Chunk upload failed");y.value=F.uploadedChunks,w.value=F.progress,g.value=y.value/b.value*S.value,J()},W=async()=>{const s=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),e=await fetch(`/api/upload/${f.value}/finalize`,{method:"POST",headers:{"X-CSRF-TOKEN":s,Accept:"application/json"},credentials:"same-origin"});if(!e.ok)throw e.status===401||e.status===419?new Error("Session expired. Please refresh the page."):new Error(`Finalization failed: ${e.status}`);const o=await e.json();if(!o.success)throw new Error(o.error||"Upload finalization failed");p.value=!1,v.value=!0,M("upload-success",{filePath:o.filePath,fileName:d.value.name,fileSize:o.fileSize,duration:o.duration,storageDisk:o.storage_disk||"public"})},P=async()=>{if(f.value)try{await fetch(`/api/upload/${f.value}/cancel`,{method:"DELETE",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}})}catch(s){console.error("Cancel upload error:",s)}$(),M("cancel")},H=()=>{c.value="",w.value=0,y.value=0,p.value=!1,T()},$=()=>{d.value=null,j.value=null,O.value=!1,R.value=0,p.value=!1,w.value=0,y.value=0,b.value=0,v.value=!1,c.value="",f.value="",g.value=0,S.value=0},C=s=>{if(s===0)return"0 Bytes";const e=1024,o=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(s)/Math.log(e));return parseFloat((s/Math.pow(e,a)).toFixed(2))+" "+o[a]},J=()=>{if(!E.value)return;const s=(Date.now()-E.value)/1e3,e=g.value/s;U.value=`${C(e)}/s`;const a=(S.value-g.value)/e;if(isFinite(a))if(a<60)z.value=`${Math.round(a)}s`;else if(a<3600)z.value=`${Math.round(a/60)}m ${Math.round(a%60)}s`;else{const r=Math.floor(a/3600),i=Math.floor(a%3600/60);z.value=`${r}h ${i}m`}};return Q(()=>{f.value&&p.value&&P()}),(s,e)=>(k(),x("div",ee,[!p.value&&!v.value?(k(),x("div",te,[t("input",{ref:"fileInput",type:"file",accept:"video/*",onChange:L,class:"hidden"},null,544),t("div",{onClick:e[0]||(e[0]=o=>s.$refs.fileInput.click()),onDragover:e[1]||(e[1]=N(()=>{},["prevent"])),onDrop:N(K,["prevent"]),class:"border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer hover:border-indigo-400 hover:bg-indigo-50/50 transition-all duration-200"},[...e[2]||(e[2]=[A('<div class="flex flex-col items-center space-y-4" data-v-f0ee7c85><svg class="w-12 h-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-f0ee7c85><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" data-v-f0ee7c85></path></svg><div data-v-f0ee7c85><p class="text-lg font-semibold text-slate-700" data-v-f0ee7c85>Click to upload or drag and drop</p><p class="text-sm text-slate-500 mt-1" data-v-f0ee7c85>Supports MP4, MOV, AVI, WMV, MKV up to 1GB</p><p class="text-xs text-slate-400 mt-2" data-v-f0ee7c85>Fast chunked upload with compression</p></div></div>',1)])],32)])):_("",!0),d.value&&!p.value&&!v.value?(k(),x("div",se,[t("div",ae,[t("div",oe,[e[3]||(e[3]=t("div",{class:"w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center"},[t("svg",{class:"w-5 h-5 text-indigo-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})])],-1)),t("div",null,[t("p",le,u(d.value.name),1),t("p",ne,u(C(d.value.size)),1)])]),t("div",{class:"flex items-center space-x-2"},[t("button",{onClick:T,class:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-200"}," Start Upload "),t("button",{onClick:q,class:"px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors duration-200"}," Cancel ")])])])):_("",!0),p.value?(k(),x("div",re,[t("div",ie,[t("div",de,[t("div",ce,[e[5]||(e[5]=t("div",{class:"w-8 h-8 bg-green-100 rounded-full flex items-center justify-center"},[t("svg",{class:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})])],-1)),t("div",null,[e[4]||(e[4]=t("p",{class:"font-semibold text-slate-800"},"Uploading Video...",-1)),t("p",ue,u(y.value)+"/"+u(b.value)+" chunks â€¢ "+u(U.value),1)])]),t("button",{onClick:P,class:"text-red-600 hover:text-red-700 text-sm font-medium"}," Cancel ")]),t("div",pe,[t("div",ve,[e[6]||(e[6]=t("span",{class:"text-slate-600"},"Progress",-1)),t("span",fe,u(w.value.toFixed(1))+"%",1)]),t("div",he,[t("div",{class:"bg-gradient-to-r from-green-500 to-emerald-600 h-3 rounded-full transition-all duration-300",style:Y({width:w.value+"%"})},null,4)]),t("div",me,[t("span",null,u(C(g.value))+" / "+u(C(S.value)),1),t("span",null,"ETA: "+u(z.value),1)])])])])):_("",!0),v.value?(k(),x("div",ge,[t("div",{class:"bg-green-50 border border-green-200 rounded-xl p-6"},[e[7]||(e[7]=A('<div class="flex items-center space-x-3" data-v-f0ee7c85><div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center" data-v-f0ee7c85><svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-f0ee7c85><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" data-v-f0ee7c85></path></svg></div><div data-v-f0ee7c85><p class="font-semibold text-green-800" data-v-f0ee7c85>Upload Successful!</p><p class="text-sm text-green-600" data-v-f0ee7c85>Video uploaded and processed successfully</p></div></div>',1)),t("button",{onClick:$,class:"mt-3 text-sm text-green-700 hover:text-green-800 font-medium"}," Upload Another Video ")])])):_("",!0),c.value?(k(),x("div",xe,[t("div",ke,[t("div",we,[e[9]||(e[9]=t("svg",{class:"w-5 h-5 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.126 16.5c-.77.833.192 2.5 1.732 2.5z"})],-1)),t("div",null,[e[8]||(e[8]=t("p",{class:"font-medium text-red-800"},"Upload Failed",-1)),t("p",ye,u(c.value),1)])]),t("button",{onClick:H,class:"mt-2 text-sm text-red-700 hover:text-red-800 font-medium"}," Try Again ")])])):_("",!0)]))}},_e=Z(be,[["__scopeId","data-v-f0ee7c85"]]);export{_e as C};
